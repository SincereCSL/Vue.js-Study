<template>
  <div class="topology-container">
    <div id="topology-graph" class="graph-container"></div>
  </div>
</template>

<script setup>
import { onMounted, onUnmounted } from 'vue'
import { Graph, iconfont } from '@antv/g6'

let graph = null
let currentData = null // Â≠òÂÇ®ÂΩìÂâçÊï∞ÊçÆ

onMounted(() => {
  const container = document.getElementById('topology-graph')
  if (!container) return
  container.innerHTML = ''

  // 1. Âä†ËΩΩ iconfont
  const style = document.createElement('style')
  style.innerHTML = `@import url('${iconfont.css}');`
  document.head.appendChild(style)

  const width = container.scrollWidth || 1200
  const height = container.scrollHeight || 900

  // 2. ÂáÜÂ§áÊï∞ÊçÆ - Âè™Êúâ‰∏ªËäÇÁÇπÔºåÂ≠êËäÇÁÇπÂä®ÊÄÅÊ∑ªÂä†
  currentData = {
    nodes: [
      {
        id: 'ISBG-Node',
        type: 'hexagon',
        x: width / 2,
        y: height / 2,
        style: {
          size: 80,
          labelText: 'ISBG',
          labelPosition: 'bottom',
          labelOffset: 20,
          labelFill: '#fff',
          labelFontSize: 16,
          labelFontWeight: 'bold',
          fill: 'l(90) 0:#87CEEB 0.5:#3498DB 1:#1F4E79',
          stroke: '#4A90E2',
          lineWidth: 3,
          shadowColor: 'rgba(0,0,0,0.5)',
          shadowBlur: 15,
          shadowOffsetX: 8,
          shadowOffsetY: 8,
          iconFontFamily: 'iconfont',
          iconText: '\ue602',
          iconFill: 'rgba(255,255,255,0.8)',
          iconFontSize: 32,
        },
      },
    ],
    edges: [],
  }

  // 3. ÂàõÂª∫ÂõæÂΩ¢ÁöÑÂáΩÊï∞
  function createGraph() {
    if (graph) {
      graph.destroy()
    }

    graph = new Graph({
      container,
      width,
      height,
      data: currentData,
      node: {
        type: 'hexagon',
        style: {
          labelText: (d) => d.style?.labelText || d.id,
          labelPosition: 'bottom',
          labelOffset: (d) => d.style?.labelOffset || 15,
          labelFill: (d) => d.style?.labelFill || '#fff',
          labelFontSize: (d) => d.style?.labelFontSize || 12,
          labelFontWeight: (d) => d.style?.labelFontWeight || 'normal',
          size: (d) => d.style?.size || 50,
          fill: (d) => d.style?.fill || '#87CEEB',
          stroke: (d) => d.style?.stroke || '#4A90E2',
          lineWidth: (d) => d.style?.lineWidth || 2,
          shadowColor: (d) => d.style?.shadowColor || 'rgba(0,0,0,0.3)',
          shadowBlur: (d) => d.style?.shadowBlur || 10,
          shadowOffsetX: (d) => d.style?.shadowOffsetX || 5,
          shadowOffsetY: (d) => d.style?.shadowOffsetY || 5,
          iconFontFamily: (d) => d.style?.iconFontFamily || 'iconfont',
          iconText: (d) => d.style?.iconText || '\ue602',
          iconFill: (d) => d.style?.iconFill || 'rgba(255,255,255,0.8)',
          iconFontSize: (d) => d.style?.iconFontSize || 20,
          opacity: (d) => (d.style?.opacity !== undefined ? d.style.opacity : 1),
        },
        state: {
          hover: {
            fill: 'l(90) 0:#9FD3E7 0.5:#4AA3D8 1:#25619B',
            shadowBlur: 20,
          },
          selected: {
            stroke: '#E74C3C',
            lineWidth: 4,
          },
        },
      },
      edge: {
        style: {
          stroke: (d) => d.style?.stroke || '#4A90E2',
          lineWidth: (d) => d.style?.lineWidth || 2,
          endArrow: (d) => d.style?.endArrow !== false,
        },
      },
      behaviors: ['drag-canvas', 'zoom-canvas', 'click-select'],
      layout: {
        type: 'preset',
      },
    })

    // 4. ÂÆûÁé∞ÁÇπÂáªÂ±ïÂºÄ/Êî∂Ëµ∑ÂäüËÉΩ
    let isExpanded = false

    graph.on('node:click', (e) => {
      try {
        console.log('üñ±Ô∏è ËäÇÁÇπË¢´ÁÇπÂáª:', e)

        // Ëé∑ÂèñËäÇÁÇπID
        const nodeId = e.itemId || (e.item && e.item.id) || (e.target && e.target.id)
        console.log('üéØ ËäÇÁÇπID:', nodeId)

        // Âè™Â§ÑÁêÜ‰∏ªËäÇÁÇπÁöÑÁÇπÂáª‰∫ã‰ª∂
        if (nodeId !== 'ISBG-Node') {
          console.log('‚ÑπÔ∏è Èùû‰∏ªËäÇÁÇπÁÇπÂáªÔºåÂøΩÁï•')
          return
        }

        console.log('üìä ÂΩìÂâçÂ±ïÂºÄÁä∂ÊÄÅ:', isExpanded)

        if (isExpanded) {
          // Êî∂Ëµ∑ÔºöÂà†Èô§Â≠êËäÇÁÇπÂíåËøûÊé•Á∫ø
          try {
            console.log('üîÑ ÂºÄÂßãÊî∂Ëµ∑Êìç‰Ωú...')

            // Ëé∑ÂèñÂΩìÂâçÊï∞ÊçÆ
            const graphData = graph.getData()

            // ÈáçÁΩÆÊï∞ÊçÆÂà∞ÂàùÂßãÁä∂ÊÄÅ
            const resetData = {
              nodes: [
                {
                  id: 'ISBG-Node',
                  type: 'hexagon',
                  x: width / 2,
                  y: height / 2,
                  style: {
                    size: 80,
                    labelText: 'ISBG',
                    labelPosition: 'bottom',
                    labelOffset: 20,
                    labelFill: '#fff',
                    labelFontSize: 16,
                    labelFontWeight: 'bold',
                    fill: 'l(90) 0:#87CEEB 0.5:#3498DB 1:#1F4E79',
                    stroke: '#4A90E2',
                    lineWidth: 3,
                    shadowColor: 'rgba(0,0,0,0.5)',
                    shadowBlur: 15,
                    shadowOffsetX: 8,
                    shadowOffsetY: 8,
                    iconFontFamily: 'iconfont',
                    iconText: '\ue602',
                    iconFill: 'rgba(255,255,255,0.8)',
                    iconFontSize: 32,
                  },
                },
              ],
              edges: [],
            }

            // Êõ¥Êñ∞currentDataÂºïÁî®
            currentData.nodes = resetData.nodes
            currentData.edges = resetData.edges

            // ÈáçÊñ∞ÂàõÂª∫ÂõæÂΩ¢
            createGraph()

            isExpanded = false
            console.log('‚úÖ Êî∂Ëµ∑ÂÆåÊàê')
          } catch (error) {
            console.error('‚ùå Êî∂Ëµ∑Êìç‰ΩúÂ§±Ë¥•:', error)
          }
        } else {
          // Â±ïÂºÄÔºöÊ∑ªÂä†Â≠êËäÇÁÇπÂíåËøûÊé•Á∫ø
          try {
            console.log('üîÑ ÂºÄÂßãÂ±ïÂºÄÊìç‰Ωú...')

            // Ëé∑ÂèñÂΩìÂâçÊï∞ÊçÆ
            const graphData = graph.getData()

            // ÂÖàÊ∏ÖÁêÜÂèØËÉΩÂ≠òÂú®ÁöÑÂ≠êËäÇÁÇπÔºåÈò≤Ê≠¢ÈáçÂ§çÊ∑ªÂä†
            currentData.nodes = currentData.nodes.filter((n) => n.id === 'ISBG-Node')
            currentData.edges = []

            // ‰øÆÊîπ‰∏ªËäÇÁÇπ‰∏∫ÂçäÈÄèÊòé
            const mainNode = currentData.nodes.find((n) => n.id === 'ISBG-Node')
            if (mainNode) {
              mainNode.style = {
                ...mainNode.style,
                opacity: 0.3,
              }
            }

            // Ê∑ªÂä†Â≠êËäÇÁÇπ
            const subNodes = [
              {
                id: 'sub-1',
                type: 'hexagon',
                x: width / 2 + 300, // Âè≥‰æßÔºåË∑ùÁ¶ª‰∏ªËäÇÁÇπ300ÂÉèÁ¥†
                y: height / 2,
                style: {
                  size: 50,
                  labelText: 'ËäÇÁÇπ1',
                  labelPosition: 'bottom',
                  labelFill: '#fff',
                  labelFontSize: 12,
                  fill: '#87CEEB',
                  stroke: '#4A90E2',
                  lineWidth: 2,
                  iconFontFamily: 'iconfont',
                  iconText: '\ue602',
                  iconFill: '#fff',
                  iconFontSize: 20,
                },
              },
              {
                id: 'sub-2',
                type: 'hexagon',
                x: width / 2,
                y: height / 2 - 250, // ‰∏äÊñπÔºåË∑ùÁ¶ª‰∏ªËäÇÁÇπ250ÂÉèÁ¥†
                style: {
                  size: 50,
                  labelText: 'ËäÇÁÇπ2',
                  labelPosition: 'bottom',
                  labelFill: '#fff',
                  labelFontSize: 12,
                  fill: '#87CEEB',
                  stroke: '#4A90E2',
                  lineWidth: 2,
                  iconFontFamily: 'iconfont',
                  iconText: '\ue602',
                  iconFill: '#fff',
                  iconFontSize: 20,
                },
              },
              {
                id: 'sub-3',
                type: 'hexagon',
                x: width / 2 - 300, // Â∑¶‰æßÔºåË∑ùÁ¶ª‰∏ªËäÇÁÇπ300ÂÉèÁ¥†
                y: height / 2,
                style: {
                  size: 50,
                  labelText: 'ËäÇÁÇπ3',
                  labelPosition: 'bottom',
                  labelFill: '#fff',
                  labelFontSize: 12,
                  fill: '#87CEEB',
                  stroke: '#4A90E2',
                  lineWidth: 2,
                  iconFontFamily: 'iconfont',
                  iconText: '\ue602',
                  iconFill: '#fff',
                  iconFontSize: 20,
                },
              },
              {
                id: 'sub-4',
                type: 'hexagon',
                x: width / 2,
                y: height / 2 + 250, // ‰∏ãÊñπÔºåË∑ùÁ¶ª‰∏ªËäÇÁÇπ250ÂÉèÁ¥†
                style: {
                  size: 50,
                  labelText: 'ËäÇÁÇπ4',
                  labelPosition: 'bottom',
                  labelFill: '#fff',
                  labelFontSize: 12,
                  fill: '#87CEEB',
                  stroke: '#4A90E2',
                  lineWidth: 2,
                  iconFontFamily: 'iconfont',
                  iconText: '\ue602',
                  iconFill: '#fff',
                  iconFontSize: 20,
                },
              },
            ]

            // Ê∑ªÂä†ËøûÊé•Á∫ø
            const subEdges = [
              {
                id: 'edge-1',
                source: 'ISBG-Node',
                target: 'sub-1',
                style: {
                  stroke: '#4A90E2',
                  lineWidth: 2,
                  endArrow: true,
                },
              },
              {
                id: 'edge-2',
                source: 'ISBG-Node',
                target: 'sub-2',
                style: {
                  stroke: '#4A90E2',
                  lineWidth: 2,
                  endArrow: true,
                },
              },
              {
                id: 'edge-3',
                source: 'ISBG-Node',
                target: 'sub-3',
                style: {
                  stroke: '#4A90E2',
                  lineWidth: 2,
                  endArrow: true,
                },
              },
              {
                id: 'edge-4',
                source: 'ISBG-Node',
                target: 'sub-4',
                style: {
                  stroke: '#4A90E2',
                  lineWidth: 2,
                  endArrow: true,
                },
              },
            ]

            // Êõ¥Êñ∞currentData
            currentData.nodes = [...currentData.nodes, ...subNodes]
            currentData.edges = [...currentData.edges, ...subEdges]

            // ÈáçÊñ∞ÂàõÂª∫ÂõæÂΩ¢
            createGraph()

            isExpanded = true
            console.log('‚úÖ Â±ïÂºÄÂÆåÊàê')
          } catch (error) {
            console.error('‚ùå Â±ïÂºÄÊìç‰ΩúÂ§±Ë¥•:', error)
          }
        }
      } catch (error) {
        console.error('‚ùå ÁÇπÂáªÂ§ÑÁêÜÂá∫Èîô:', error)
      }
    })

    graph.render()
    console.log('‚úÖ ÂõæÂΩ¢Ê∏≤ÊüìÂÆåÊàê')
  }

  // ÂàùÂßãÂàõÂª∫ÂõæÂΩ¢
  createGraph()
})

onUnmounted(() => {
  if (graph) {
    graph.destroy()
    graph = null
  }
})
</script>

<style scoped>
.topology-container {
  width: 100vw;
  height: 100vh;
  background: linear-gradient(135deg, #0a1628 0%, #1a2a3a 100%);
  display: flex;
  justify-content: center;
  align-items: center;
}
.graph-container {
  width: 1200px;
  height: 900px;
  border: 2px solid #00d4ff;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
  background: rgba(255, 255, 255, 0.05);
}
</style>
